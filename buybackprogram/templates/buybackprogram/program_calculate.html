{% extends 'buybackprogram/page.html' %}
{% load i18n %}
{% load humanize %}
{% load bootstrap %}
{% load static %}
{% load dict %}
{% load number %}

{% block body %}
{% if buyback_data %}
<div class="table-responsive" style="margin: 20px 0;">
    <p class="text-success">Based on the items we have calculated a contract for you. Please use the following settings when creating a buyback contract:</p>
    <h4>Contract settings</h4>
    <table id="contract" style="margin: 20px auto;" class="table table-striped table-condensed">
        <tr>
            <th>Contract type:</th>
            <td>Item Exhange</td>
        </tr>
        <tr>
            <th>Availability:</th>
            {% if program.corporation %}
                <td>{{program.owner.corporation}}</td>
            {% else %}
                <td>{{program.owner}}</td>
            {% endif %}
        </tr>
        <tr>
            <th>I will receive:</th>
            {% if contract_price_data.contract_net_total >= 0%}
                <td>{{contract_price_data.contract_net_total|intcomma }}</td>
            {% else %}
                <td>0 ISK <i><s>{{contract_price_data.contract_net_total|intcomma }} ISK</s></i><td>
            {% endif %}


        </tr>
        <tr>
            <th>Expiration:</th>
            <td>1 week</td>
        </tr>
        <tr>
            <th>Description:</th>
            <td>TODO: TRACKING NUMBER HERE</td>
        </tr>
    </table>
</div>

<div class="table-responsive" style="margin: 20px 0;">
    <h4>Invoice</h4>
        <p class="text-muted">List of expenses applied on your contract</p>
    <table id="contract" style="margin: 20px auto;" class="table table-striped table-condensed">
        <tr>
            <th>Price before expenses</th>
            <td>{{contract_price_data.total_all_items_raw|floatformat:0|intcomma}} ISK</td>
        </tr>
        <tr>
            <th>Program taxes</th>
          <td>{{contract_price_data.total_tax_amount|floatformat:0|intcomma}} ISK</td>
        </tr>
        {% if program.hauling_fuel_cost > 0 %}
        <tr>
            <th>Hauling cost</th>
            <td>{{contract_price_data.total_hauling_cost|floatformat:0|intcomma}} ISK</td>
        </tr>
        {% endif %}
        {% if contract_price_data.total_donation_amount %}
        <tr>
            <th>Donation amount</th>
            <td>{{contract_price_data.total_donation_amount|floatformat:0|intcomma}} ISK <i>({{donation}} %)</i></td>
        </tr>
        {% endif %}
        <tr>
            <th style="border-top:2px dotted black;">Net price</th>
            {% if contract_price_data.contract_net_total >= 0%}
                <td style="border-top:2px dotted black;">{{contract_price_data.contract_net_total|intcomma }}</td>
            {% else %}
                <td style="border-top:2px dotted black;">0 ISK <i><s>{{contract_price_data.contract_net_total|intcomma }} ISK</s></i><td>
            {% endif %}
        </tr>

    </table>
</div>

<div class="table-responsive" style="margin: 20px 0;">
    <h4>Item details</h4>
    <p class="text-muted">Details for each item and their price calculations</p>
    <table id="value" style="margin: 20px auto;" class="table table-striped table-condensed">
        <thead>
            <tr>
                <th>Name</th>
                <th>Quantity</th>
                <th>Jita sell ISK</th>
                <th>Jita buy ISK</th>
                <th>Tax %</th>
                <th>Row value ISK</th>
            </tr>
        </thead>
        <tbody>
            {% for item in buyback_data %}
            <tr>
                <td>{{ item.item_values.normal.name }}</td>
                <td>{{ item.item_values.normal.quantity }}</td>
                <td>{{ item.item_values.normal.sell|floatformat:0|intcomma }}</td>
                <td>{{ item.item_values.normal.buy|floatformat:0|intcomma }}</td>
                <td>{{ item.item_values.normal.total_tax }} %</td>
                <td>{{ item.item_values.normal.value|floatformat:0|intcomma }}</td>
            </tr>
            {% if item.item_values.compressed %}
                <tr>
                    <td colspan="5" style="padding-left:20px;">Compressed value:</td>
                    <td>{{ item.item_values.compression_value|floatformat:0|intcomma}}</td>
                </tr>
            {% endif %}


            {% if item.item_values.refined %}
                <tr>
                    <td colspan="5" style=";padding-left:20px;">Refined value:</td>
                    <td>{{ item.item_values.material_value|floatformat:0|intcomma}}</td>
                </tr>
                {% for material in item.item_values.refined %}
                <tr style="border-top:1 px solid red;">
                    <td style="padding-left:40px;"><i>{{material.name}}</i></td>
                    <td><i>{{material.quantity}}</i></td>
                    <td><i>{{material.sell|floatformat:0|intcomma}}</i></td>
                    <td><i>{{material.buy|floatformat:0|intcomma}}</i></td>
                    <td><i>{{material.total_tax}} %</i></td>
                    <td><i>{{material.value|floatformat:0|intcomma}}</i></td>
                </tr>
                {% endfor %}
            {% endif %}
            {% if not forloop.last %}
            <tr>
                <td colspan="6" style="padding-bottom:30px"></td>
            </tr>
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

{% endif %}

<h4>{{ program.location }}</h4>
<form class="form" action="{% url 'buybackprogram:program_calculate' program_pk=program.id %}" method="POST">
    {% csrf_token %}
    {{ form|bootstrap }}
    <button type="submit" class="btn btn-primary">Calculate</button>
  </form>
{% endblock %}

{% block extra_javascript %}
<script type="text/javascript" src="{% static 'buybackprogram/js/notify.js' %}"></script>
{% endblock %}

{% block extra_css %}
{% endblock %}

{% block extra_script %}
{% endblock %}
